<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>universal audiobook maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,Arial;background:#0e1015;color:#e6ecf8;margin:0;padding:0}
main{max-width:800px;margin:auto;padding:20px}
textarea,input,select,button{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #222;background:#1a1f2b;color:#e6ecf8}
button{cursor:pointer;background:#2b4b8b}
button:hover{background:#3557a2}
#status{font-size:14px;color:#8fbaff;margin:10px 0}
audio{width:100%;margin-top:10px}
</style>
</head>
<body>
<main>
<h1>free audiobook maker (works on all browsers)</h1>
<p>no webgpu required — runs with wasm. works on chrome, firefox, librewolf, safari, android, ios, mac, windows, linux.</p>

<label>story prompt</label>
<textarea id="prompt" placeholder="a ww1 survivor telling his story"></textarea>

<label>length (minutes)</label>
<select id="length">
<option>5</option><option selected>10</option><option>15</option><option>20</option>
</select>

<label>voice</label>
<select id="voice">
<option value="male">male</option>
<option value="female">female</option>
<option value="old">old man</option>
<option value="young">young man</option>
<option value="soft">soft narrator</option>
</select>

<button id="generate">generate & speak</button>
<div id="status">loading tts engine…</div>
<audio id="player" controls></audio>
</main>

<script type="module">
import { pipeline } from "https://huggingface.co/spaces/Xenova/transformers.js/resolve/main/dist/transformers.min.js";
import "https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js";

const $ = id=>document.getElementById(id);
const player = $("player");
const statusEl = $("status");
let tts = null;

(async()=>{
  try{
    statusEl.textContent="loading speech model (wasm)…";
    tts = await pipeline("text-to-speech","onnx-community/OuteTTS-0.2-500M",{device:"wasm"});
    statusEl.textContent="ready.";
  }catch(e){
    console.error(e);
    statusEl.textContent="failed to load tts model.";
  }
})();

function floatTo16BitPCM(float32){
  const buf=new ArrayBuffer(float32.length*2);
  const view=new DataView(buf);
  for(let i=0;i<float32.length;i++){
    let s=Math.max(-1,Math.min(1,float32[i]));
    view.setInt16(i*2,s<0?s*0x8000:s*0x7FFF,true);
  }
  return new Int16Array(buf);
}
function makeWavBlob(float32,sampleRate){
  const pcm16=floatTo16BitPCM(float32);
  const wavBytes=44+pcm16.length*2;
  const buf=new ArrayBuffer(wavBytes);
  const view=new DataView(buf);
  let off=0;
  const write=(s)=>{for(let i=0;i<s.length;i++)view.setUint8(off++,s.charCodeAt(i));};
  write("RIFF");view.setUint32(off,36+pcm16.length*2,true);off+=4;
  write("WAVEfmt ");view.setUint32(off,16,true);off+=4;
  view.setUint16(off,1,true);off+=2;view.setUint16(off,1,true);off+=2;
  view.setUint32(off,sampleRate,true);off+=4;view.setUint32(off,sampleRate*2,true);off+=4;
  view.setUint16(off,2,true);off+=2;view.setUint16(off,16,true);off+=2;
  write("data");view.setUint32(off,pcm16.length*2,true);off+=4;
  new Int16Array(buf,44).set(pcm16);
  return new Blob([buf],{type:"audio/wav"});
}

$("generate").onclick=async()=>{
  const topic=$("prompt").value.trim();
  if(!topic){alert("enter a prompt");return;}
  statusEl.textContent="generating story text…";

  // basic offline text generator
  const templates=[
    `my name is arthur and this is how ${topic} began.`,
    `people remember the wars by dates; i remember them by smells.`,
    `the rain never stopped, and the ground shook like an animal.`,
    `when i finally came home, silence felt foreign.`
  ];
  const story=templates.join(" ")+" it taught me that even survival has a cost.";

  statusEl.textContent="speaking…";
  const res=await tts(story,{language:"en"});
  const wav=makeWavBlob(res.audio,res.sampling_rate);
  player.src=URL.createObjectURL(wav);
  player.play();
  statusEl.textContent="done.";
};
</script>
</body>
</html>
