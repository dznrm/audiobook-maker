<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>free audiobook maker — universal (wasm tts, no cdn imports)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#111826; --muted:#97a3b6; --text:#e7eefc; --accent:#65b3ff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0a0d12);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    header{padding:20px 16px;border-bottom:1px solid #162033}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid #162033;border-radius:14px;padding:14px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    textarea,input,select{width:100%;background:#0c141f;color:var(--text);border:1px solid #1b2b46;border-radius:10px;padding:10px 12px}
    textarea{min-height:140px;resize:vertical}
    button{background:#17365d;color:#e7eefc;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    .status{font-size:13px;color:var(--accent)}
    .history-item{padding:10px;border:1px solid #1b2b46;border-radius:12px;margin:10px 0}
    .title-line{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .story{white-space:pre-wrap;background:#0c141f;border:1px solid #1b2b46;border-radius:10px;padding:10px;margin-top:8px;max-height:240px;overflow:auto}
    .pill{font-size:12px;color:#9ecbff;background:#14253e;border:1px solid #214770;border-radius:999px;padding:2px 8px}
    .small{font-size:12px}
    .audio-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .progress{height:6px;background:#0c141f;border:1px solid #1b2b46;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#5fa8ff,#86ffd8)}
    .danger{background:#3a1111;border-color:#5b1a1a}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width: 640px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>free audiobook maker (wasm, no cdn imports)</h1>
    <div class="muted">tts runs via wasm, so it works on chrome, firefox, librewolf, safari, android, ios. no webgpu needed. ai voice pick uses simple rules (no external llm) so it never hangs.</div>
  </header>

  <div class="wrap">
    <!-- composer -->
    <section class="card">
      <div class="row">
        <div class="pill">offline • wasm tts</div>
        <div id="status" class="status">loading speech engine… first run caches a small model</div>
      </div>

      <div class="grid">
        <div>
          <label for="prompt">your idea</label>
          <textarea id="prompt" placeholder="e.g., a ww1 survivor recounts the trenches and returning home"></textarea>
        </div>
        <div>
          <label for="minutes">target length (minutes)</label>
          <select id="minutes"><option>5</option><option selected>10</option><option>15</option><option>20</option><option>30</option></select>
          <label for="wpm">reading pace (words/min)</label>
          <input id="wpm" type="number" value="150" min="110" max="190" />
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="genBtn">generate story</button>
        <button id="stopGenBtn" class="danger">stop</button>
        <div class="muted">aims for your minutes × WPM</div>
      </div>

      <label for="story" style="margin-top:10px">story draft (editable)</label>
      <textarea id="story" placeholder="generated story appears here. edit freely before audio. "></textarea>

      <hr style="border:none;height:1px;background:#162033;margin:14px 0" />

      <!-- voices -->
      <div class="grid">
        <div>
          <label for="voiceMode">voice mode</label>
          <select id="voiceMode">
            <option value="dynamic" selected>dynamic (auto-pick)</option>
            <option value="manual">manual select</option>
          </select>
        </div>
        <div id="manualBox">
          <label for="voiceProfile">voice profile</label>
          <select id="voiceProfile"></select>
          <div class="row">
            <button id="previewBtn">preview voice</button>
            <span class="muted" style="font-size:12px">sample: “the winter of 1917 never left me.”</span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="ttsBtn">make audio</button>
        <button id="stopTtsBtn" class="danger">stop audio</button>
        <button id="downloadBtn">download mp3</button>
      </div>

      <div class="audio-row">
        <audio id="player" controls style="width:100%"></audio>
      </div>
      <div class="progress" style="margin-top:8px"><div id="prog" class="bar"></div></div>
    </section>

    <!-- history -->
    <aside class="card">
      <div class="row" style="justify-content:space-between">
        <div class="pill">history</div>
        <div class="row">
          <button id="exportAll">export all (.json)</button>
          <button id="clearAll" class="danger">clear all</button>
        </div>
      </div>
      <div id="historyList" class="muted">no items yet.</div>
    </aside>
  </div>

  <!-- scripts -->
  <script type="module">
    // local, self-hosted transformers bundle (no CORS/MIME issues)
    import { pipeline } from "./lib/transformers.min.js";
    // mp3 encoder from jsdelivr is fine for <script src>; it's not a module import
    import "https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js";

    const $ = id => document.getElementById(id);
    const statusEl = $("status"), progEl = $("prog");
    const promptEl = $("prompt"), minutesEl = $("minutes"), wpmEl = $("wpm");
    const storyEl = $("story"), player = $("player");
    const genBtn = $("genBtn"), stopGenBtn = $("stopGenBtn");
    const ttsBtn = $("ttsBtn"), stopTtsBtn = $("stopTtsBtn"), downloadBtn = $("downloadBtn");
    const exportAllBtn = $("exportAll"), clearAllBtn = $("clearAll"), historyList = $("historyList");
    const voiceModeEl = $("voiceMode"), voiceProfileEl = $("voiceProfile"), previewBtn = $("previewBtn"), manualBox = $("manualBox");

    // voices (multi-model)
    const VOICES = [
      { id:"old-man-1",   name:"old man (expressive, bark)",     model:"bark", preset:"v2/en_speaker_6" },
      { id:"old-man-2",   name:"old man (calm, multi)",          model:"oute", speaker:2 },
      { id:"narrator",    name:"narrator (neutral, multi)",      model:"oute", speaker:0 },
      { id:"young-man-1", name:"young man (bark)",               model:"bark", preset:"v2/en_speaker_3" },
      { id:"young-man-2", name:"young man (multi)",              model:"oute", speaker:1 },
      { id:"boy",         name:"boy (light, bark)",              model:"bark", preset:"v2/en_speaker_9" },
      { id:"woman-1",     name:"woman (warm, multi)",            model:"oute", speaker:3 },
      { id:"woman-2",     name:"woman (expressive, bark)",       model:"bark", preset:"v2/en_speaker_1" },
      { id:"uk-narrator", name:"narrator (uk vibe, bark)",       model:"bark", preset:"v2/en_speaker_8" },
      { id:"soft-elder",  name:"elder soft (multi)",             model:"oute", speaker:4 },
      { id:"radio-host",  name:"radio host (bark)",              model:"bark", preset:"v2/en_speaker_7" },
      { id:"storyteller", name:"storyteller (deep, bark)",       model:"bark", preset:"v2/en_speaker_5" },
    ];
    voiceProfileEl.innerHTML = VOICES.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");
    manualBox.style.display = "block"; // keep visible so you can preview even in dynamic mode

    // init TTS (WASM)
    let ttsOute = null; // OuteTTS multi-speaker
    let ttsBark = null; // Bark-small expressive (lazy load)
    let wavPCM = null, wavRate = 24000;
    let stopGen = false;

    statusEl.textContent = "loading speech (wasm)…";
    (async () => {
      ttsOute = await pipeline("text-to-speech", "onnx-community/OuteTTS-0.2-500M", { device: "wasm" });
      statusEl.textContent = "speech ready (wasm).";
    })().catch(e => {
      console.error(e);
      statusEl.textContent = "failed to init speech (wasm). refresh or try another browser.";
    });

    async function ensureBark(){
      if (ttsBark) return;
      statusEl.textContent = "loading expressive voice engine (bark, wasm)…";
      ttsBark = await pipeline("text-to-speech", "Xenova/bark-small", { device:"wasm" });
      statusEl.textContent = "speech ready (wasm).";
    }

    // simple offline generator (works everywhere)
    const beats = [["opening", .18],["inciting", .1],["rising", .18],["climax", .18],["falling", .18],["resolution", .18]];
    function wordsForMinutes(mins, wpm){ return Math.max(120, Math.floor(mins*wpm)); }
    function riff(topic){
      const bits=[
        `the ${topic} wasn’t a story so much as a sequence of small choices.`,
        `someone always kept watch; someone always pretended not to be afraid.`,
        `i remember the smell: oil, damp fabric, and metal shavings.`,
        `we traded rumors like currency, half-hope, half-danger.`,
        `i wrote things down so i wouldn’t forget, then lost the pages anyway.`,
        `names mattered; we said them out loud so they wouldn’t vanish.`,
        `time stretched and then snapped back like a wire.`,
        `you learn which sounds mean run, and which mean breathe.`,
        `we promised to meet after, as if after was guaranteed.`,
        `if courage existed, it looked ordinary and tired.`
      ];
      return bits[Math.floor(Math.random()*bits.length)];
    }
    function paragraph(beat, topic, words){
      const hooks={
        opening:["i’ll start where it still hurts:","people remember the headlines, not the mud.","the air had that metallic taste again."],
        inciting:["the first real change came with","i didn’t believe the rumors until","the letter arrived at dawn,"],
        rising:["days bled together after that.","there was a rhythm to the fear.","we learned to joke with empty stomachs."],
        climax:["then came the thing no one trains for.","the world narrowed to breath and heartbeat.","it felt like the sky folded in on itself."],
        falling:["when it ended, the silence was heavier than the shelling.","we counted what we had left, and who.","i didn’t sleep so much as drift."],
        resolution:["if there’s any lesson, it’s this:","home is different when you return different.","i keep a small box of things that survived with me."]
      };
      const seed = hooks[beat][Math.floor(Math.random()*hooks[beat].length)];
      const avg=16; const sents=Math.max(3, Math.floor(words/avg));
      let p=[seed+" "+riff(topic)];
      for(let i=1;i<sents;i++) p.push(riff(topic));
      return p.join(" ").replace(/\s+/g," ").replace(/\s([,.!?;:])/g,"$1");
    }
    function generateOffline(topic, targetWords){
      return beats.map(([b,f])=>paragraph(b, topic, Math.max(60, Math.floor(targetWords*f)))).join("\n\n");
    }

    // dynamic voice pick (rule-based so it never blocks)
    function rulePickVoice(prompt, text){
      const s=`${prompt}\n${text}`.toLowerCase();
      if (/(ww1|war|veteran|trenches|elder|grandfather|old man)/.test(s)) return "old-man-2";
      if (/(narrator|documentary|history|expository)/.test(s)) return "narrator";
      if (/(radio|news|host|show)/.test(s)) return "radio-host";
      if (/(woman|mother|her story|she )/.test(s)) return "woman-1";
      if (/(boy|child|kid)/.test(s)) return "boy";
      if (/(young man|teen|student|he )/.test(s)) return "young-man-2";
      return "narrator";
    }
    function getVoiceById(id){ return VOICES.find(v=>v.id===id) || VOICES[0]; }

    // history
    function ts(){ return new Date().toISOString(); }
    function titleFromPrompt(p){ return (p||"untitled").slice(0,80).trim() || "untitled"; }
    function saveHistory(item){
      const k="audiobook_hist_v3";
      const arr=JSON.parse(localStorage.getItem(k)||"[]");
      arr.unshift(item);
      localStorage.setItem(k, JSON.stringify(arr.slice(0,300)));
      renderHistory();
    }
    function renderHistory(){
      const arr=JSON.parse(localStorage.getItem("audiobook_hist_v3")||"[]");
      historyList.innerHTML = arr.length ? arr.map((x,i)=>`
        <div class="history-item">
          <div class="title-line">
            <div>
              <div class="small">${new Date(x.date).toLocaleString()}</div>
              <strong>${x.title}</strong>
              <div class="small muted">${x.voiceName || "—"}</div>
            </div>
            <div class="row">
              <button data-act="load" data-idx="${i}">load</button>
              <button data-act="delete" data-idx="${i}" class="danger">delete</button>
            </div>
          </div>
          <div class="story small">${x.text.slice(0,400)}${x.text.length>400?"…":""}</div>
        </div>
      `).join("") : `<div class="muted">no items yet.</div>`;
    }
    function delHistory(idx){
      const k="audiobook_hist_v3";
      const arr=JSON.parse(localStorage.getItem(k)||"[]" );
      arr.splice(idx,1);
      localStorage.setItem(k, JSON.stringify(arr));
      renderHistory();
    }
    renderHistory();
    historyList.addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const act=btn.dataset.act, idx=+btn.dataset.idx;
      const arr=JSON.parse(localStorage.getItem("audiobook_hist_v3")||"[]");
      if(act==="delete"){ delHistory(idx); return; }
      if(act==="load"){ const it=arr[idx]; promptEl.value=it.prompt||""; storyEl.value=it.text||""; voiceProfileEl.value=it.voiceId||VOICES[0].id; }
    });
    clearAllBtn.onclick=()=>{ if(confirm("clear all history?")){ localStorage.removeItem("audiobook_hist_v3"); renderHistory(); } };
    exportAllBtn.onclick=()=>{
      const data=localStorage.getItem("audiobook_hist_v3")||"[]";
      const blob=new Blob([data],{type:"application/json"});
      const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:"audiobook_history.json"}); a.click();
    };

    // story generation (offline, no llm so it always works)
    genBtn.onclick=()=>{
      stopGen=false;
      const prompt=promptEl.value.trim(); if(!prompt){ alert("enter a prompt"); return; }
      const target=wordsForMinutes(+minutesEl.value, +wpmEl.value);
      storyEl.value = generateOffline(prompt, target);
    };
    stopGenBtn.onclick=()=>{ stopGen=true; };

    // tts helpers
    function splitIntoSentences(text){ return text.replace(/\s+/g,' ').match(/[^.!?]+[.!?]+|\S+$/g) || [text]; }
    async function runTTSWithVoice(text, voice){
      const useBark = voice.model === "bark";
      if (useBark) await ensureBark();
      const pipe = useBark ? ttsBark : ttsOute;

      const sents = splitIntoSentences(text);
      const chunks=[]; let mergedLen=0;
      statusEl.textContent = `synthesizing (${voice.name})…`; progEl.style.width="0%";

      for(let i=0;i<sents.length;i++){
        const part=sents[i].trim(); if(!part) continue;
        let res;
        if(useBark){ res = await pipe(part, { voice_preset: voice.preset||"v2/en_speaker_6" }); }
        else { res = await pipe(part, { language:"en", speaker_id: (voice.speaker ?? 0) }); }
        const pcm = res.audio instanceof Float32Array ? res.audio : new Float32Array(res.audio);
        wavRate = res.sampling_rate || 24000;
        chunks.push(pcm); mergedLen += pcm.length;
        progEl.style.width = `${Math.min(100, ((i+1)/sents.length)*100)}%`;
        await new Promise(r=>setTimeout(r,0));
      }
      const merged=new Float32Array(mergedLen);
      let off=0; for(const c of chunks){ merged.set(c, off); off+=c.length; }
      return { audio: merged, rate: wavRate };
    }
    function floatTo16BitPCM(float32){
      const buf=new ArrayBuffer(float32.length*2), view=new DataView(buf);
      for(let i=0;i<float32.length;i++){ let s=Math.max(-1,Math.min(1,float32[i])); view.setInt16(i*2, s<0?s*0x8000:s*0x7FFF, true); }
      return new Int16Array(buf);
    }
    function makeWavBlob(float32, sampleRate){
      const pcm16=floatTo16BitPCM(float32);
      const wavBytes=44+pcm16.length*2; const buf=new ArrayBuffer(wavBytes); const view=new DataView(buf);
      let off=0; const w=s=>{ for(let i=0;i<s.length;i++) view.setUint8(off++, s.charCodeAt(i)); };
      w('RIFF'); view.setUint32(off,36+pcm16.length*2,true); off+=4; w('WAVEfmt '); view.setUint32(off,16,true); off+=4;
      view.setUint16(off,1,true); off+=2; view.setUint16(off,1,true); off+=2; view.setUint32(off,sampleRate,true); off+=4;
      view.setUint32(off,sampleRate*2,true); off+=4; view.setUint16(off,2,true); off+=2; view.setUint16(off,16,true); off+=2; w('data');
      view.setUint32(off, pcm16.length*2, true); off+=4; new Int16Array(buf,44).set(pcm16); return new Blob([buf],{type:"audio/wav"});
    }
    function playPCM(float32, sampleRate){
      const wavBlob=makeWavBlob(float32, sampleRate);
      player.src = URL.createObjectURL(wavBlob);
      player.play().catch(()=>{});
    }
    function downloadMP3(float32, sampleRate, filename="story.mp3"){
      const pcm16 = floatTo16BitPCM(float32);
      const samples = Array.from(pcm16);
      const mp3enc = new lamejs.Mp3Encoder(1, sampleRate, 128);
      const chunk = 1152; const mp3=[];
      for(let i=0;i<samples.length;i+=chunk){
        const buf = mp3enc.encodeBuffer(samples.slice(i,i+chunk));
        if(buf.length) mp3.push(buf);
      }
      const end = mp3enc.flush(); if(end.length) mp3.push(end);
      const blob=new Blob(mp3,{type:"audio/mpeg"});
      const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:filename}); a.click();
    }

    // preview / synth / save
    previewBtn.onclick = async ()=>{
      const v=getVoiceById(voiceProfileEl.value);
      const {audio,rate}=await runTTSWithVoice("the winter of 1917 never left me.", v);
      playPCM(audio, rate);
    };
    ttsBtn.onclick = async ()=>{
      const text=storyEl.value.trim(); if(!text){ alert("no story text to read"); return; }
      let voiceId = voiceProfileEl.value;
      if(voiceModeEl.value === "dynamic"){ voiceId = rulePickVoice(promptEl.value, text); voiceProfileEl.value = voiceId; }
      const v=getVoiceById(voiceId);
      const {audio,rate}=await runTTSWithVoice(text, v);
      playPCM(audio, rate);
      const item={ date: new Date().toISOString(), title: titleFromPrompt(promptEl.value), prompt: promptEl.value, text, voiceId: v.id, voiceName: v.name };
      const k="audiobook_hist_v3"; const arr=JSON.parse(localStorage.getItem(k)||"[]"); arr.unshift(item); localStorage.setItem(k, JSON.stringify(arr.slice(0,300))); renderHistory();
    };
    stopTtsBtn.onclick=()=>{ player.pause(); };

    // history buttons already wired above
  </script>
</body>
</html>
